# 캐시

## 캐시란?

- 자주 사용하는 데이터나 값을 미리 복사해 놓는 임시 장소
- 저장공간이 작고 비용이 비싼 대신 빠른 성능을 제공
  ![캐시](/docs/img/cache.png)

### 사용목적

- 반복적으로 동일한 결과를 돌려주는 경우 캐시를 사용하여 빠른 응답을 제공
- 적은 부하로 응답이 필요한 경우
    - 데이터베이스나 외부 API 호출을 줄이기 위해 사용
    - ex) DNS, CPU, CDN, DB(쿼리), API 호출(GET)

# Server Caching 전략

- 캐싱 전략은 어플리케이션의 성능을 최적화하기 위해 데이터를 캐시에 저장하고 관리하는 방식을 정의

## Caching 전략의 종류

### Write Through

- 데이터를 캐시에 쓰는 동시에 원본 데이터 소스(데이터베이스 혹은 유사한 저장소)에도 즉시 쓰는 방식
    - 캐시와 데이터베이스의 데이터 일관성은 유지되지만, 쓰기성능 저하
- 사용 사례: 데이터 일관성이 중요한 경우
- 데이터의 일관성이 중요한 경우 사용 됨으로 금융 거래 시스템(계좌 잔고, 실시간 결제 등)에서 사용

### Write Behind (Write Back)

- 데이터를 캐시에 먼저 쓰고, 나중에 원본 데이터 소스에 비동기적으로 쓰는 방식
    - 데이터의 일관성이 보장 되지 않을 수 있음
- 사용 사례: 쓰기 작업이 빈번하지만 즉각적인 일관성이 필요하지 않는 경우
- 로그나 로그를 수집하는 시스템의 데이터를 캐시에 먼저 작성하고 주기적인 동기화를 이용

### Read-Through

- 데이터를 캐시에 먼저 읽고, 캐시에 데이터가 없는 경우 원본 데이터 소스에서 읽어서 캐시에 저장하는 방식
- 사용 사례: 자주 읽히는 데이터를 빠르게 제공 하기 위해 사용
- CDN이나 DNS 서버에서 주로 사용 ( 특히 CDN 설명과 동일함 )

### Look Aside

- 데이터를 찾을 때 우선 캐시에 저장된 데이터가 있는지 학인하고 없다면 원본 데이터 소스에 젝접 조회
- Read-Through와의 차이점은 데이터 동기화를 라이브러리 또는 캐시제공자에게 위임
- 사용 사례: 반복적 읽기가 많은 호출에 적합, 캐시를 제공하는 서버(redis, nginx)가 다운 되더라도 데이터를 읽을 수 있음

### Cache-Aside(Lazy Loading)

- 어플리케이션에 데이터를 캐시에서 직접 관리하는 방식
    - 데이터를 읽을 때 캐시에 데이터가 있는지 확인하고 없으면 데이터를 읽어서 캐시에 저장
- 사용 사례: 캐시관리가 어플리케이션 자체에 있는 경우

## Fuzzy와 Update Cache 전략

- Fuzzy Cache
    - 캐시 무효화 전략의 일종으로, 캐시된 데이터가 특정 조건이나 패턴에 맞지 않을 때 캐시를 무효화하거나 제거
- Update Cache
    - 캐시된 데이터가 갱싱 될 때 원본 데이터 소스의 변경에 따라 캐시를 업데이트 하는 방식

# 캐시 스탬피드 현상 ( Cache Stampede )

## 원인

- 일반적으로 Look Aside을 채택하여 사용하고 있을 때 캐시공간은 한정되어 있음으로 저장된 데이터를 데이터 만료시간(TTL)을 설정하게 되는데(일반적으로)
  해당 데이터의 읽기 요청이 계속해서 들어오고 있을 때 캐시가 만료되어 데이터가 삭제되는 경우 캐시에 붙어있던 connection이 데이터 베이스에 요청을 하게 되는데
  이때 데이터 베이스에 요청이 많아지게 되어 데이터 베이스에 부하가 걸리게 되는 현상
  ![캐시 스탬피드](/docs/img/cache-stampede.png)

## 해결 방법

- 적절한 만료 시간 설정
- 만료시간 선 계산
- 확률적 접근
- PER 알고리즘 (확률적 조기 재계산) - Probabilistic Early Recomputation

### 적절한 만료 시간 설정

- 캐시의 만료시간을 너무 짧게 설정하지 않는 방식
- 결국 캐시가 만료되는건 동일 함으로 캐시 스탬피드현상을 막을 순 없음

## 만료 시간 선 계산

- 캐시의 만료시간을 미리 계산하여 캐시가 만료되기 전에 새로운 데이터를 캐시에 저장하는 방식
- 캐시의 저장공간은 한정되어 있고 저장공간을 계속해서 리소스를 사용하게 되는 단점이 있음

## 확률적 접근

- 만료시간이 가까워 질 수록 캐시의 데이터를 조회할때 DB에 접근해 데이터를 갱신
- 확률적으로 데이터를 미리 갱신하여 캐시 스탬피드 현상을 방지하지만 갱신되지 않는 경우 동일한 문제가 발생함

## PER 알고리즘 (확률적 조기 재계산)

- 확률적으로 데이터를 미리 갱신하여 캐시 스탬피드 현상을 방지하고 갱신되지 않는 경우를 방지하기 위한 알고리즘
- 캐시의 만료시간을 미리 계산하여 캐시가 만료되기 전에 새로운 데이터를 캐시에 저장하는 방식

# redis-cli

## redis-cli 설치 (Mac)

```Bash
# 설치
 brew install redis  
# 확인
redis-server --version
```

### redis 정보 보기

```Bash
redis-cli info
# 연결된 서버가 없을 때
Could not connect to Redis at 127.0.0.1:6379: Connection refused
# 연결되어 있는 경우
redis_version:7.4.2
redis_git_sha1:00000000
...
```

### 레디스 기본 명령어

```Bash
# Key의 전체 갯수 가져오기
dbsize

# Key의 전체 리스트 가져오기
keys *

# Key의 전체 리스트 가져오기 (패턴)
keys {패턴}
# Ex) keys userId:[1-3]

# Key에 값 저장하기
set {key} {value}

# Key에 값 가져오기
get {key}

# Key에 값 삭제하기
del {key}

# 모든 키 삭제하기
flushAll

# 만료시간 설정
EXPIRE {key} {seconds}

# 키 생성과 동시에 만료시간 설정 ( 초 단위 )
SETEX {key} {seconds} {value}

# 키 생성과 동시에 만료시간 설정 ( 밀리초 단위 )
PSETEX {key} {milliseconds} {value}

# 만료시간 확인 ( 초 단위 )
TTL {key}

# 만료시간 확인 ( 밀리초 단위 )
PTTL {key}

# 만료시간 제거
PERSIST {key}
```
