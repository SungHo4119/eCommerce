```
- 서비스의 규모가 확장되어 MSA의 형태로 각 도메인별로 배포단위를 분리해야한다면 그 분리에 따른 트랜잭션 처리의 한계와 해결방안에 대한 서비스 설계 문서 작성
- 실시간 주문(이커머스), 좌석예약 정보(콘서트)를 데이터 플랫폼에 전달(mock API 호출)하는 요구사항 등을 기존 로직에 추가해 보고 기존 로직에 영향을 주지 않도록 개선
```

# 트랜잭션이란?

- 데이터 베이스의 상태를 변화시키기 위해서 수행하는 작업의 단위
  ![트랜잭션의](/docs/img/transaction.png)

## 트랜잭션의 특징

- 원자성 (Atomicity): 트랜잭션이 데이터베이스 모두 반영 되거나 아니면 전혀 반영되지 않아야 한다.
- 일관성 (Consistency): 트랜잭션의 작업 처리가 항사 일관성 있어야 한다.
- 독립성 (Isolation): 어떤 하나의 트랜잭션이라도, 다른 트랜잭션의 연산에 끼어들 수 없다
- 지속성 (Durability): 트랜잭션을 성공적으로 완료됐을 경우 결과는 영구적으로 반영왼다.

# MSA 적용시 트랜잭션의 한계와 해결방안

- 분산 트랜 잭션 관리의 어려움
    - SAGA 패턴
    - 2PC(Two-Phase Commit)
- 트랜잭션이 일관성을 보장하지 않고 데이터 불일치 문제 발생
    - 이벤트 소싱(Event Sourcing)
- 트랜잭션의 롤백 불가능
    - SAGA 패턴

# SAGA 패턴

## SAGA 패턴이란?

- SAGA 패턴은 MSA(Microservices Architecture) 환경에서 분산 트랜잭션을 관리하는 패턴
- 각 서비스가 독립적으로 트랜잭션을 수행하면서, 실패 시 보상(Compensating Transactions) 을 통해 정합성을 유지
    - 기존 단일 트랜잭션(ACID)과 달리, MSA에서는 전체 롤백이 불가능하므로 SAGA 패턴을 사용하여 각 서비스가 트랜잭션을 단계적으로 관리

## SARGA 패턴의 동작 방식

- Choreography-based
    - 각 서비스가 이벤트를 발행하고, 다른 서비스가 이벤트를 구독하여 처리
      ![Choreography](/docs/img/choreography.png)
- Orchestration-based
    - Orchestration 서비스가 각 서비스에게 요청을 보내고, 각 서비스가 요청에 따라 처리
      ![Orchestration](/docs/img/orchestration.png)

## 보상 트랜잭션

- SAGA 패턴에서 트랜잭션 처리 중 실패 시, 보상 트랜잭션을 통해 이전 상태로 복구

### 보상 트랜잭션이 필요한 이유

- MSA 환경에서는 DB 트랜잭션(ACID)을 유지하기 어려움
- 모놀리식 아키텍처의 트랜잭션 롤백 기능이 여러 마이크로 서비스에 걸쳐 동작하지 않음
- 각 서비스가 독립적으로 트랜잭션을 수행함으로, 실패 시 전체를 되돌릴 방법이 필요하고 각 단계에 따라 보상 트랜잭션을 수행

# 이커머스 MSA 설계

## 이커머스 결재 시나리오

- 기존 결재 로직을 기반으로 MSA 환경으로 전환 하기 위한 설계를 진행

```JAVA
public Payment processPayment(Long orderId) {
    // 주문 상태 확인
    // 주문 상태 변경 (결재 진행중)
    // 사용자(잔액) 조회
    // 잔액 차감
    // 결재 진행
    // 주문 상태 변경 (결재 완료)
}
```

### 도메인 별 서비스 분리

- 단순 서비스를 분리하는것에서 끝나는 것이 아니라 각 서비스의 트랜잭션 처리를 고려하여 설계가 필요
    - 잔액을 차감하는 요구사항이 있다면 잔액을 증가하는 요구사항도 있을 가능성이 높고 단순히 특정 동작에 대한 보상 트랜잭션을 정의하는것도 좋지만 반대로 동작하는 기존의
      기능을 활용하는 것도 좋음

--- 

- 사용자 서비스
    - 사용자 정보 조회
    - 사용자 잔액 조회
    - 사용자 잔액 차감(결재 시나리오에 대한 요구 사항 + 보상 트랜잭션으로 활용 가능)
    - 사용자 잔액 증가(보상 트랜잭션으로 활용하고 + 포인트 충전 시나리오에 대한 요구 사항으로 사용)
- 주문 서비스
    - 주문 조회
    - 주문 상태 변경
- 결재 서비스
    - 결재 진행(결재 시나리오에 대한 요구 사항 + 보상 트랜잭션으로 활용 가능)
    - 결재 취소(보상 트랜잭션으로 활용하고 + 결재 취소 시나리오에 대한 요구 사항으로 사용)

---

### 이커머스 결재 시나리오의 MSA 서비스

- 아래의 순서로 이벤트 기반 MSA 서비스를 구성이 가능
    - 1)주문 서비스: 주문상태 조회, 주문 상태 변경
    - 2)사용자 서비스: 사용자 정보 조회, 사용자 잔액 조회, 사용자 잔액 차감
    - 3)결재 서비스: 결재 진행
    - 4)주문 서비스: 주문 상태 변경

### 보상 트랜잭션 적용 방안

- 1)주문 서비스에서 실패하는 경우
    - 주문 서비스 자체의 트랜잭션으로 롤백 진행하여 정합성 보장
- 2)사용자 서비스에서 실패하는 경우
    - 잔액차감의 경우 사용자 서비스 내부의 트랜잭션 롤백으로 동작하고 주문 상태 변경에 대한 보상 트랜잭션 수행
- 3)결재 서비스에서 실패하는 경우
    - 결재 서비스 내부의 트랜잭션 롤백으로 동작하고 주문 상태 변경, 잔액 차감에 대한 보상 트랜잭션(잔액 증가) 수행
- 4)주문 서비스에서 실패하는 경우
    - 결재 취소 이벤트 발행하여 결재 서비스에서 결재 취소 처리
        - 결재 취소라 함은 결재된 금액에 대한 환불처리를 진행하고 주문 상태에 대한 값만 이벤트 발행시 적절히 변경해주도록 설계 